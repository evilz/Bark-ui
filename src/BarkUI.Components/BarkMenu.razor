@namespace BarkUI.Components

<div class="bark-menu__container" @attributes="AdditionalAttributes">
    <div class="bark-menu__trigger" @onclick="Toggle">
        @TriggerContent
    </div>
    @if (isOpen)
    {
        <div class="@GetClasses()" role="menu">
            @ChildContent
        </div>
    }
</div>

@code {
    [Parameter]
    public RenderFragment? TriggerContent { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public string Placement { get; set; } = "bottom-start";

    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private bool isOpen;

    protected override void OnParametersSet()
    {
        isOpen = IsOpen;
    }

    private string GetClasses()
    {
        var classes = new List<string> { "bark-menu" };
        classes.Add($"bark-menu--{Placement}");

        if (AdditionalAttributes?.ContainsKey("class") == true)
        {
            classes.Add(AdditionalAttributes["class"].ToString() ?? string.Empty);
        }

        return string.Join(" ", classes);
    }

    private async Task Toggle()
    {
        isOpen = !isOpen;
        IsOpen = isOpen;
        await IsOpenChanged.InvokeAsync(isOpen);
    }

    internal async Task Close()
    {
        isOpen = false;
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
        StateHasChanged();
    }
}
