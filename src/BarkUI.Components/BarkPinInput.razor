@namespace BarkUI.Components

<div class="bark-pin-input-wrapper">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="bark-pin-input-label">@Label</label>
    }
    <div class="bark-pin-input-container">
        @for (int i = 0; i < Length; i++)
        {
            var index = i;
            <input 
                type="@(Mask ? "password" : "text")"
                class="@GetPinInputClasses()"
                maxlength="1"
                value="@GetDigitValue(index)"
                disabled="@Disabled"
                @oninput="e => HandleInput(e, index)"
                @onkeydown="e => HandleKeyDown(e, index)"
                @ref="inputRefs[index]" />
        }
    </div>
</div>

@code {
    [Parameter]
    public string? Label { get; set; }

    [Parameter]
    public string Value { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    [Parameter]
    public int Length { get; set; } = 4;

    [Parameter]
    public bool Mask { get; set; } = false;

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public string Size { get; set; } = "md";

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private ElementReference[] inputRefs = Array.Empty<ElementReference>();

    protected override void OnInitialized()
    {
        inputRefs = new ElementReference[Length];
    }

    private string GetDigitValue(int index)
    {
        return index < Value.Length ? Value[index].ToString() : string.Empty;
    }

    private async Task HandleInput(ChangeEventArgs e, int index)
    {
        var input = e.Value?.ToString() ?? string.Empty;
        if (input.Length > 0)
        {
            var digit = input[input.Length - 1];
            if (char.IsDigit(digit))
            {
                var chars = Value.ToCharArray();
                if (index < chars.Length)
                {
                    chars[index] = digit;
                    Value = new string(chars);
                }
                else
                {
                    Value = Value.PadRight(index, ' ') + digit;
                }
                
                Value = Value.TrimEnd();
                await ValueChanged.InvokeAsync(Value);
                
                // Move to next input if available
                if (index < Length - 1)
                {
                    // Note: Focus management would require JS interop
                }
            }
        }
        else if (input.Length == 0)
        {
            // Handle deletion
            if (index < Value.Length)
            {
                Value = Value.Remove(index, 1);
                await ValueChanged.InvokeAsync(Value);
            }
        }
    }

    private Task HandleKeyDown(KeyboardEventArgs e, int index)
    {
        if (e.Key == "Backspace" && index > 0 && string.IsNullOrEmpty(GetDigitValue(index)))
        {
            // Move to previous input on backspace if current is empty
        }
        return Task.CompletedTask;
    }

    private string GetPinInputClasses()
    {
        var classes = new List<string> { "bark-pin-input" };
        classes.Add($"bark-pin-input--{Size}");
        
        if (Disabled)
        {
            classes.Add("bark-pin-input--disabled");
        }

        if (AdditionalAttributes?.ContainsKey("class") == true)
        {
            classes.Add(AdditionalAttributes["class"].ToString() ?? string.Empty);
        }

        return string.Join(" ", classes);
    }
}
